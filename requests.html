<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Requests | LeafyLibrary</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: linear-gradient(to bottom right, #0f2e1d, #1f4037);
    }
    .glass {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>

<body class="min-h-screen text-white">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<!-- NAVBAR -->
<nav class="flex justify-between items-center px-8 py-5">
  <h1 class="text-2xl font-bold">ðŸŒ¿ LeafyLibrary</h1>
  <div class="flex gap-6 items-center">
    <a href="home.html" class="hover:underline">Home</a>
    <a href="marketplace.html" class="hover:underline">Marketplace</a>
    <a href="list-book.html" class="hover:underline">List Book</a>
    <a href="requests.html" class="hover:underline">My Requests</a>
    <button id="logout" class="bg-red-500 px-4 py-2 rounded-lg hover:bg-red-600 transition">
      Logout
    </button>
  </div>
</nav>

<!-- MAIN -->
<main class="px-8 py-12">
  <h2 class="text-3xl font-bold mb-6 text-center">My Requests ðŸ“¬</h2>

  <div id="requests" class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto"></div>

  <p id="empty" class="text-center text-gray-300 mt-10 hidden">
    No requests yet ðŸŒ±
  </p>
  <script>
async function loadRequests() {
  const { data: userData } = await supabaseClient.auth.getUser();
  const user = userData.user;

  // Fetch requests for logged-in user
  const { data: requests, error } = await supabaseClient
    .from("requests")
    .select("*")
    .eq("requester_id", user.id)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error fetching requests:", error);
    return;
  }

  const container = document.getElementById("requests");
  const emptyMsg = document.getElementById("empty");
  container.innerHTML = "";

  if (!requests || requests.length === 0) {
    emptyMsg.classList.remove("hidden");
    return;
  }
  emptyMsg.classList.add("hidden");

  for (const req of requests) {
    const { data: book } = await supabaseClient
      .from("books")
      .select("*")
      .eq("id", req.book_id)
      .single();

    const card = document.createElement("div");
    card.className = "glass p-6 rounded-2xl";

    card.innerHTML = `
      <h3 class="text-xl font-semibold mb-1">${book.title}</h3>
      <p class="text-gray-200 mb-2">${book.author}</p>
      <p class="mb-1">
        Type: <span class="font-semibold text-green-300">${req.type}</span>
      </p>
      ${
        req.type === "sell"
          ? `<p class="mb-1">Price: <b>â‚¹${req.price}</b></p>`
          : `<p class="mb-1 text-green-200">Exchange only</p>`
      }
      <p class="mt-3">
        Status:
        <span class="px-3 py-1 rounded-full text-sm ${
          req.status === "pending"
            ? "bg-yellow-500"
            : req.status === "approved"
            ? "bg-green-600"
            : "bg-red-600"
        }">
          ${req.status}
        </span>
      </p>
    `;

    container.appendChild(card);
  }
}

loadRequests();
</script>
</main>

<script>
  // Protect page
  supabaseClient.auth.getUser().then(({ data }) => {
    if (!data.user) window.location.href = "auth.html";
  });

  async function loadRequests() {
    const { data: userData } = await supabaseClient.auth.getUser();
    const user = userData.user;

    // Fetch all requests for this user
    const { data: requests, error } = await supabaseClient
      .from("requests")
      .select("*")
      .eq("requester_id", user.id)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Error fetching requests:", error);
      return;
    }

    const container = document.getElementById("requests");
    const emptyMsg = document.getElementById("empty");
    container.innerHTML = "";

    if (!requests || requests.length === 0) {
      emptyMsg.classList.remove("hidden");
      return;
    }
    emptyMsg.classList.add("hidden");

    // Loop through each request
    for (const req of requests) {
      // Fetch the book info
      const { data: book, error: bookError } = await supabaseClient
        .from("books")
        .select("*")
        .eq("id", req.book_id)
        .single();

      if (bookError) {
        console.error("Error fetching book info:", bookError);
        continue;
      }

      // Create card
      const card = document.createElement("div");
      card.className = "glass p-6 rounded-2xl";

      card.innerHTML = `
        <h3 class="text-xl font-semibold mb-1">${book.title}</h3>
        <p class="text-gray-200 mb-2">${book.author}</p>

        <p class="mb-1">
          Type:
          <span class="font-semibold text-green-300">${req.type}</span>
        </p>

        ${
          req.type === "sell"
            ? `<p class="mb-1">Price: <b>â‚¹${req.price}</b></p>`
            : `<p class="mb-1 text-green-200">Exchange only</p>`
        }

        <p class="mt-3">
          Status:
          <span class="px-3 py-1 rounded-full text-sm ${
            req.status === "pending"
              ? "bg-yellow-500"
              : req.status === "approved"
              ? "bg-green-600"
              : "bg-red-600"
          }">
            ${req.status}
          </span>
        </p>
      `;

      container.appendChild(card);
    }
  }

  loadRequests();

  // Logout button
  document.getElementById("logout").onclick = async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "auth.html";
  };
</script>

</body>
</html>
