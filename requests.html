<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Requests | ReShelf</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(to bottom right, #0f2e1d, #1f4037); margin:0; font-family:'Lora', serif; color:white;}
    .glass { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border:1px solid rgba(255,255,255,0.2); padding:1.5rem; border-radius:1rem; }
    .fade-out { animation: fadeOut 0.5s forwards; }
    @keyframes fadeOut { to { opacity:0; transform: scale(0.95); } }
  </style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<nav class="flex justify-between items-center px-8 py-5 bg-black/30 backdrop-blur-md sticky top-0 z-50">
  <h1 class="text-2xl font-bold cursor-pointer" onclick="location.href='home.html'">ðŸŒ¿ ReShelf</h1>
  <div class="flex gap-6 items-center">
    <a href="home.html" class="hover:text-green-300 transition">Home</a>
    <a href="marketplace.html" class="hover:text-green-300 transition">Marketplace</a>
    <a href="list-book.html" class="hover:text-green-300 transition">List Book</a>
    <a href="requests.html" class="hover:text-green-300 transition">My Requests</a>
    <button id="logout" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition">Logout</button>
  </div>
</nav>

<main class="px-8 py-12">
  <h2 class="text-3xl font-bold mb-6 text-center">My Requests ðŸ“¬</h2>
  <div id="requests" class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto"></div>
  <p id="empty" class="text-center text-gray-300 mt-10 hidden">No requests yet ðŸŒ±</p>
</main>

<script>
async function protectPage() {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) { window.location.href = "auth.html"; return null; }
  return data.session.user;
}

document.getElementById("logout").onclick = async () => {
  await supabaseClient.auth.signOut();
  window.location.href = "auth.html";
};

async function loadRequests() {
  const user = await protectPage();
  if (!user) return;

  const { data: requests, error } = await supabaseClient
    .from("requests")
    .select("*")
    .eq("owner_id", user.id)
    .order("created_at", { ascending: false });

  const container = document.getElementById("requests");
  const emptyMsg = document.getElementById("empty");
  container.innerHTML = "";

  if (error || !requests || requests.length === 0) { emptyMsg.classList.remove("hidden"); return; }
  emptyMsg.classList.add("hidden");

  for (const req of requests) {
    const { data: book } = await supabaseClient
      .from("books")
      .select("title, author")
      .eq("id", req.book_id)
      .single();

    const card = document.createElement("div");
    card.className = "glass p-6 rounded-2xl";

    card.innerHTML = `
      <h3 class="text-xl font-semibold mb-1">${book.title}</h3>
      <p class="text-gray-200 mb-2">${book.author}</p>
      <p class="mb-1">Type: <span class="font-semibold text-green-300">${req.type}</span></p>
      ${req.type === "sell" ? `<p class="mb-1">Price: <b>â‚¹${req.price}</b></p>` : `<p class="mb-1 text-green-200">Exchange requested</p>`}
      <p class="mt-3 mb-4">Status: 
        <span class="px-3 py-1 rounded-full text-sm ${
          req.status === "pending" ? "bg-yellow-500" : req.status === "approved" ? "bg-green-600" : "bg-red-600"
        }">${req.status}</span>
      </p>
      ${req.status === "pending" ? `<button class="bg-green-600 w-full py-2 rounded hover:bg-green-700 transition">Approve</button>` : ""}
    `;

    const btn = card.querySelector("button");
    if (btn) {
      btn.onclick = async () => {
        if (req.type === "exchange") {
          // Generate random campus location
          const campusLocations = [
            "Library Hall",
            "Cafeteria Courtyard",
            "Main Quad",
            "Engineering Block Lobby",
            "Student Lounge"
          ];
          const randomLocation = campusLocations[Math.floor(Math.random() * campusLocations.length)];

          // Generate next-hour exchange time
          const now = new Date();
          now.setHours(now.getHours() + 1);
          const exchangeTime = now.toLocaleString();

          // Update Supabase
          const { error, data } = await supabaseClient
            .from("requests")
            .update({
              status: "approved",
              exchange_location: randomLocation,
              exchange_time: exchangeTime
            })
            .eq("id", req.id);

          console.log("Exchange update result:", { error, data });
          if (error) { alert("Approval failed âŒ"); console.error(error); return; }

          // Redirect to confirm page
          window.location.href = `exchange-confirm.html?request=${req.id}`;
          return;
        }

        // Sell request
        const { error } = await supabaseClient
          .from("requests")
          .update({ status: "approved" })
          .eq("id", req.id);

        if (error) { alert("Approval failed âŒ"); console.error(error); return; }

        card.classList.add("fade-out");
        setTimeout(() => card.remove(), 500);
      };
    }

    container.appendChild(card);
  }
}

loadRequests();
</script>
</body>
</html>

